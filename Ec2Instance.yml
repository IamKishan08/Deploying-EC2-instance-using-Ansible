---
- name: Provision and Manage EC2 Instances
  hosts: localhost
  connection: local
  gather_facts: False

  vars:
    key_name: my_aws             # Key used for SSH
    region: us-east-1            # Region may affect response and pricing
    image: ami-066784287e358dad1  # Amazon or AMI of manually launched instances
    instance_type: t2.nano       # Choose instance type, check AWS for pricing
    sec_group: "test-security-group"
    aws_access_key: "{{ ec2_access_key }}"  # From AWX credentials
    aws_secret_key: "{{ ec2_secret_key }}"  # From AWX credentials

  tasks:
    - name: Provisioning EC2 instances
      block:
        - name: Create security group
          amazon.aws.ec2_security_group:
            name: "{{ sec_group }}"
            description: "Sec group for app"
            region: "{{ region }}"
            aws_access_key: "{{ aws_access_key }}"
            aws_secret_key: "{{ aws_secret_key }}"
            rules:
              - proto: tcp
                ports:
                  - 22
                cidr_ip: 0.0.0.0/0
                rule_desc: allow all on ssh port

        - name: Create Key Pair
          amazon.aws.ec2_key:
            name: "{{ key_name }}"
            region: "{{ region }}"
            aws_access_key: "{{ aws_access_key }}"
            aws_secret_key: "{{ aws_secret_key }}"
            key_material: "{{ lookup('file', './my_aws.pub') }}"

        - name: Start an EC2 instance with a public IP address
          amazon.aws.ec2_instance:
            name: "public-compute-instance"
            key_name: "{{ key_name }}"
            instance_type: "{{ instance_type }}"
            security_group: "{{ sec_group }}"
            aws_access_key: "{{ aws_access_key }}"
            aws_secret_key: "{{ aws_secret_key }}"
            region: "{{ region }}"
            network:
              assign_public_ip: true
            image_id: "{{ image }}"
            tags:
              Environment: Testing
          register: ec2_result

      tags: ['create_ec2']

    - name: Retrieve and Display Instance Facts
      block:
        - name: Get instances facts
          amazon.aws.ec2_instance_info:
            aws_access_key: "{{ aws_access_key }}"
            aws_secret_key: "{{ aws_secret_key }}"
            region: "{{ region }}"
          register: result

        - name: Display Instance Details
          debug:
            msg: "ID: {{ item.instance_id }} - State: {{ item.state.name }} - Public DNS: {{ item.public_dns_name }}"
          loop: "{{ result.instances }}"

      tags: ['always']
